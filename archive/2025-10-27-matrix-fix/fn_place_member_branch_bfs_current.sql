                                                                                                                       pg_get_functiondef                                                                                                                       
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 CREATE OR REPLACE FUNCTION public.fn_place_member_branch_bfs(p_member_wallet character varying, p_referrer_wallet character varying, p_activation_time timestamp without time zone DEFAULT now(), p_tx_hash character varying DEFAULT NULL::character varying)+
  RETURNS jsonb                                                                                                                                                                                                                                                +
  LANGUAGE plpgsql                                                                                                                                                                                                                                             +
  SECURITY DEFINER                                                                                                                                                                                                                                             +
 AS $function$                                                                                                                                                                                                                                                 +
 DECLARE                                                                                                                                                                                                                                                       +
     v_matrix_root VARCHAR(42);                                                                                                                                                                                                                                +
     v_entry_node VARCHAR(42);                                                                                                                                                                                                                                 +
     v_parent_wallet VARCHAR(42);                                                                                                                                                                                                                              +
     v_slot VARCHAR(1);                                                                                                                                                                                                                                        +
     v_layer INTEGER;                                                                                                                                                                                                                                          +
     v_referral_type VARCHAR(20);                                                                                                                                                                                                                              +
     v_bfs_order INTEGER;                                                                                                                                                                                                                                      +
     v_config JSONB;                                                                                                                                                                                                                                           +
     v_max_depth INTEGER;                                                                                                                                                                                                                                      +
     v_fallback_mode VARCHAR(50);                                                                                                                                                                                                                              +
     v_result JSONB;                                                                                                                                                                                                                                           +
     v_entry_exists BOOLEAN;                                                                                                                                                                                                                                   +
     v_entry_layer INTEGER;                                                                                                                                                                                                                                    +
 BEGIN                                                                                                                                                                                                                                                         +
     -- Log placement start                                                                                                                                                                                                                                    +
     INSERT INTO matrix_placement_events (event_type, member_wallet, matrix_root_wallet, activation_time, tx_hash)                                                                                                                                             +
     VALUES ('placement_start', p_member_wallet, p_referrer_wallet, p_activation_time, p_tx_hash);                                                                                                                                                             +
                                                                                                                                                                                                                                                               +
     -- Check if member already placed in this matrix                                                                                                                                                                                                          +
     IF EXISTS (                                                                                                                                                                                                                                               +
         SELECT 1 FROM matrix_referrals                                                                                                                                                                                                                        +
         WHERE member_wallet = p_member_wallet                                                                                                                                                                                                                 +
         AND matrix_root_wallet = p_referrer_wallet                                                                                                                                                                                                            +
     ) THEN                                                                                                                                                                                                                                                    +
         -- Idempotent: return existing placement                                                                                                                                                                                                              +
         SELECT jsonb_build_object(                                                                                                                                                                                                                            +
             'success', true,                                                                                                                                                                                                                                  +
             'message', 'Member already placed in this matrix (idempotent)',                                                                                                                                                                                   +
             'parent_wallet', parent_wallet,                                                                                                                                                                                                                   +
             'slot', slot,                                                                                                                                                                                                                                     +
             'layer', layer,                                                                                                                                                                                                                                   +
             'referral_type', referral_type,                                                                                                                                                                                                                   +
             'already_placed', true                                                                                                                                                                                                                            +
         )                                                                                                                                                                                                                                                     +
         INTO v_result                                                                                                                                                                                                                                         +
         FROM matrix_referrals                                                                                                                                                                                                                                 +
         WHERE member_wallet = p_member_wallet                                                                                                                                                                                                                 +
         AND matrix_root_wallet = p_referrer_wallet;                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                               +
         RETURN v_result;                                                                                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                               +
     -- Step 1: Determine matrix_root (fixed = referrer)                                                                                                                                                                                                       +
     v_matrix_root := p_referrer_wallet;                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                               +
     -- Load configuration                                                                                                                                                                                                                                     +
     SELECT (SELECT config_value::INTEGER FROM matrix_config WHERE config_key = 'max_layer_depth') INTO v_max_depth;                                                                                                                                           +
     SELECT (SELECT config_value::TEXT FROM matrix_config WHERE config_key = 'branch_bfs_fallback') INTO v_fallback_mode;                                                                                                                                      +
                                                                                                                                                                                                                                                               +
     v_max_depth := COALESCE(v_max_depth, 19);                                                                                                                                                                                                                 +
     v_fallback_mode := COALESCE(TRIM(BOTH '"' FROM v_fallback_mode), 'fallback_to_global');                                                                                                                                                                   +
                                                                                                                                                                                                                                                               +
     -- Step 2: Determine entry node                                                                                                                                                                                                                           +
     -- Entry node = referrer's placement in this matrix tree                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                    +
         EXISTS(SELECT 1 FROM matrix_referrals WHERE member_wallet = p_referrer_wallet AND matrix_root_wallet = v_matrix_root),                                                                                                                                +
         layer                                                                                                                                                                                                                                                 +
     INTO v_entry_exists, v_entry_layer                                                                                                                                                                                                                        +
     FROM matrix_referrals                                                                                                                                                                                                                                     +
     WHERE member_wallet = p_referrer_wallet                                                                                                                                                                                                                   +
     AND matrix_root_wallet = v_matrix_root;                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                               +
     IF NOT v_entry_exists AND p_referrer_wallet != v_matrix_root THEN                                                                                                                                                                                         +
         -- Referrer is not placed yet (and is not the root)                                                                                                                                                                                                   +
         -- Recursively place the referrer first                                                                                                                                                                                                               +
         v_result := fn_place_member_branch_bfs(                                                                                                                                                                                                               +
             p_referrer_wallet,                                                                                                                                                                                                                                +
             v_matrix_root,                                                                                                                                                                                                                                    +
             p_activation_time - INTERVAL '1 second', -- Slightly earlier to maintain order                                                                                                                                                                    +
             p_tx_hash                                                                                                                                                                                                                                         +
         );                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                               +
         IF NOT (v_result->>'success')::BOOLEAN THEN                                                                                                                                                                                                           +
             -- Failed to place referrer                                                                                                                                                                                                                       +
             INSERT INTO matrix_placement_events (                                                                                                                                                                                                             +
                 event_type, member_wallet, matrix_root_wallet,                                                                                                                                                                                                +
                 activation_time, tx_hash, error_message                                                                                                                                                                                                       +
             )                                                                                                                                                                                                                                                 +
             VALUES (                                                                                                                                                                                                                                          +
                 'placement_failed', p_member_wallet, v_matrix_root,                                                                                                                                                                                           +
                 p_activation_time, p_tx_hash,                                                                                                                                                                                                                 +
                 'Failed to place referrer: ' || (v_result->>'message')                                                                                                                                                                                        +
             );                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                               +
             RETURN jsonb_build_object(                                                                                                                                                                                                                        +
                 'success', false,                                                                                                                                                                                                                             +
                 'message', 'Failed to place referrer node',                                                                                                                                                                                                   +
                 'error', v_result                                                                                                                                                                                                                             +
             );                                                                                                                                                                                                                                                +
         END IF;                                                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                               +
     -- Entry node is now the referrer (either was already placed, or just placed above)                                                                                                                                                                       +
     v_entry_node := p_referrer_wallet;                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                               +
     -- Step 3: Find available slot using Branch-First BFS                                                                                                                                                                                                     +
     -- Start from entry node's subtree                                                                                                                                                                                                                        +
     WITH RECURSIVE branch_bfs AS (                                                                                                                                                                                                                            +
         -- Base case: Start from entry node                                                                                                                                                                                                                   +
         SELECT                                                                                                                                                                                                                                                +
             CASE                                                                                                                                                                                                                                              +
                 WHEN p_referrer_wallet = v_matrix_root THEN v_matrix_root                                                                                                                                                                                     +
                 ELSE p_referrer_wallet                                                                                                                                                                                                                        +
             END as current_node,                                                                                                                                                                                                                              +
             CASE                                                                                                                                                                                                                                              +
                 WHEN p_referrer_wallet = v_matrix_root THEN 0                                                                                                                                                                                                 +
                 ELSE (SELECT layer FROM matrix_referrals WHERE member_wallet = p_referrer_wallet AND matrix_root_wallet = v_matrix_root)                                                                                                                      +
             END as current_layer,                                                                                                                                                                                                                             +
             0 as depth_from_entry                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                               +
         UNION ALL                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                               +
         -- Recursive case: Expand children (L, M, R order)                                                                                                                                                                                                    +
         SELECT                                                                                                                                                                                                                                                +
             mr.member_wallet,                                                                                                                                                                                                                                 +
             mr.layer,                                                                                                                                                                                                                                         +
             bfs.depth_from_entry + 1                                                                                                                                                                                                                          +
         FROM branch_bfs bfs                                                                                                                                                                                                                                   +
         JOIN matrix_referrals mr ON mr.parent_wallet = bfs.current_node                                                                                                                                                                                       +
             AND mr.matrix_root_wallet = v_matrix_root                                                                                                                                                                                                         +
         WHERE bfs.depth_from_entry < v_max_depth                                                                                                                                                                                                              +
         AND mr.layer < v_max_depth                                                                                                                                                                                                                            +
     ),                                                                                                                                                                                                                                                        +
     available_slots AS (                                                                                                                                                                                                                                      +
         -- Find first parent node with available slot                                                                                                                                                                                                         +
         SELECT DISTINCT ON (bfs.current_node)                                                                                                                                                                                                                 +
             bfs.current_node as parent,                                                                                                                                                                                                                       +
             bfs.current_layer,                                                                                                                                                                                                                                +
             CASE                                                                                                                                                                                                                                              +
                 WHEN NOT EXISTS (SELECT 1 FROM matrix_referrals WHERE parent_wallet = bfs.current_node AND matrix_root_wallet = v_matrix_root AND slot = 'L') THEN 'L'                                                                                        +
                 WHEN NOT EXISTS (SELECT 1 FROM matrix_referrals WHERE parent_wallet = bfs.current_node AND matrix_root_wallet = v_matrix_root AND slot = 'M') THEN 'M'                                                                                        +
                 WHEN NOT EXISTS (SELECT 1 FROM matrix_referrals WHERE parent_wallet = bfs.current_node AND matrix_root_wallet = v_matrix_root AND slot = 'R') THEN 'R'                                                                                        +
                 ELSE NULL                                                                                                                                                                                                                                     +
             END as available_slot,                                                                                                                                                                                                                            +
             bfs.depth_from_entry                                                                                                                                                                                                                              +
         FROM branch_bfs bfs                                                                                                                                                                                                                                   +
         WHERE bfs.current_layer < v_max_depth                                                                                                                                                                                                                 +
         ORDER BY bfs.current_node, bfs.depth_from_entry ASC                                                                                                                                                                                                   +
     )                                                                                                                                                                                                                                                         +
     SELECT parent, available_slot, current_layer + 1                                                                                                                                                                                                          +
     INTO v_parent_wallet, v_slot, v_layer                                                                                                                                                                                                                     +
     FROM available_slots                                                                                                                                                                                                                                      +
     WHERE available_slot IS NOT NULL                                                                                                                                                                                                                          +
     ORDER BY depth_from_entry ASC, available_slot ASC                                                                                                                                                                                                         +
     LIMIT 1;                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                               +
     -- Step 4: Handle fallback if branch subtree is full                                                                                                                                                                                                      +
     IF v_parent_wallet IS NULL AND v_fallback_mode = 'fallback_to_global' THEN                                                                                                                                                                                +
         -- Fallback: Search entire matrix tree (global BFS)                                                                                                                                                                                                   +
         WITH RECURSIVE global_bfs AS (                                                                                                                                                                                                                        +
             SELECT v_matrix_root as current_node, 0 as current_layer, 0 as bfs_depth                                                                                                                                                                          +
                                                                                                                                                                                                                                                               +
             UNION ALL                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                               +
             SELECT mr.member_wallet, mr.layer, gbfs.bfs_depth + 1                                                                                                                                                                                             +
             FROM global_bfs gbfs                                                                                                                                                                                                                              +
             JOIN matrix_referrals mr ON mr.parent_wallet = gbfs.current_node                                                                                                                                                                                  +
                 AND mr.matrix_root_wallet = v_matrix_root                                                                                                                                                                                                     +
             WHERE gbfs.bfs_depth < v_max_depth AND mr.layer < v_max_depth                                                                                                                                                                                     +
         ),                                                                                                                                                                                                                                                    +
         global_available AS (                                                                                                                                                                                                                                 +
             SELECT DISTINCT ON (gbfs.current_node)                                                                                                                                                                                                            +
                 gbfs.current_node as parent,                                                                                                                                                                                                                  +
                 gbfs.current_layer,                                                                                                                                                                                                                           +
                 CASE                                                                                                                                                                                                                                          +
                     WHEN NOT EXISTS (SELECT 1 FROM matrix_referrals WHERE parent_wallet = gbfs.current_node AND matrix_root_wallet = v_matrix_root AND slot = 'L') THEN 'L'                                                                                   +
                     WHEN NOT EXISTS (SELECT 1 FROM matrix_referrals WHERE parent_wallet = gbfs.current_node AND matrix_root_wallet = v_matrix_root AND slot = 'M') THEN 'M'                                                                                   +
                     WHEN NOT EXISTS (SELECT 1 FROM matrix_referrals WHERE parent_wallet = gbfs.current_node AND matrix_root_wallet = v_matrix_root AND slot = 'R') THEN 'R'                                                                                   +
                     ELSE NULL                                                                                                                                                                                                                                 +
                 END as available_slot,                                                                                                                                                                                                                        +
                 gbfs.bfs_depth                                                                                                                                                                                                                                +
             FROM global_bfs gbfs                                                                                                                                                                                                                              +
             WHERE gbfs.current_layer < v_max_depth                                                                                                                                                                                                            +
             ORDER BY gbfs.current_node, gbfs.bfs_depth ASC                                                                                                                                                                                                    +
         )                                                                                                                                                                                                                                                     +
         SELECT parent, available_slot, current_layer + 1                                                                                                                                                                                                      +
         INTO v_parent_wallet, v_slot, v_layer                                                                                                                                                                                                                 +
         FROM global_available                                                                                                                                                                                                                                 +
         WHERE available_slot IS NOT NULL                                                                                                                                                                                                                      +
         ORDER BY bfs_depth ASC, available_slot ASC                                                                                                                                                                                                            +
         LIMIT 1;                                                                                                                                                                                                                                              +
     END IF;                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                               +
     -- Step 5: Validate result                                                                                                                                                                                                                                +
     IF v_parent_wallet IS NULL OR v_slot IS NULL THEN                                                                                                                                                                                                         +
         INSERT INTO matrix_placement_events (                                                                                                                                                                                                                 +
             event_type, member_wallet, matrix_root_wallet, entry_anchor,                                                                                                                                                                                      +
             activation_time, tx_hash, error_message                                                                                                                                                                                                           +
         )                                                                                                                                                                                                                                                     +
         VALUES (                                                                                                                                                                                                                                              +
             'placement_failed', p_member_wallet, v_matrix_root, v_entry_node,                                                                                                                                                                                 +
             p_activation_time, p_tx_hash, 'No available slot found (matrix full or depth limit reached)'                                                                                                                                                      +
         );                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                               +
         RETURN jsonb_build_object(                                                                                                                                                                                                                            +
             'success', false,                                                                                                                                                                                                                                 +
             'message', 'No available slot found in matrix',                                                                                                                                                                                                   +
             'matrix_root', v_matrix_root,                                                                                                                                                                                                                     +
             'entry_node', v_entry_node,                                                                                                                                                                                                                       +
             'fallback_attempted', (v_fallback_mode = 'fallback_to_global')                                                                                                                                                                                    +
         );                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                               +
     -- Determine referral_type                                                                                                                                                                                                                                +
     v_referral_type := CASE                                                                                                                                                                                                                                   +
         WHEN v_parent_wallet = v_matrix_root AND v_layer = 1 THEN 'direct'                                                                                                                                                                                    +
         ELSE 'spillover'                                                                                                                                                                                                                                      +
     END;                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                               +
     -- Calculate BFS order                                                                                                                                                                                                                                    +
     SELECT COALESCE(MAX(bfs_order), 0) + 1                                                                                                                                                                                                                    +
     INTO v_bfs_order                                                                                                                                                                                                                                          +
     FROM matrix_referrals                                                                                                                                                                                                                                     +
     WHERE matrix_root_wallet = v_matrix_root;                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                               +
     -- Step 6: Insert placement record                                                                                                                                                                                                                        +
     BEGIN                                                                                                                                                                                                                                                     +
         INSERT INTO matrix_referrals (                                                                                                                                                                                                                        +
             matrix_root_wallet, member_wallet, parent_wallet,                                                                                                                                                                                                 +
             layer, slot, referral_type, activation_time, tx_hash,                                                                                                                                                                                             +
             entry_anchor, bfs_order, source, created_at                                                                                                                                                                                                       +
         )                                                                                                                                                                                                                                                     +
         VALUES (                                                                                                                                                                                                                                              +
             v_matrix_root, p_member_wallet, v_parent_wallet,                                                                                                                                                                                                  +
             v_layer, v_slot, v_referral_type, p_activation_time, p_tx_hash,                                                                                                                                                                                   +
             v_entry_node, v_bfs_order, 'branch_bfs', NOW()                                                                                                                                                                                                    +
         );                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                               +
         -- Log success                                                                                                                                                                                                                                        +
         INSERT INTO matrix_placement_events (                                                                                                                                                                                                                 +
             event_type, member_wallet, matrix_root_wallet, entry_anchor,                                                                                                                                                                                      +
             parent_wallet, slot, layer, referral_type,                                                                                                                                                                                                        +
             activation_time, tx_hash, metadata                                                                                                                                                                                                                +
         )                                                                                                                                                                                                                                                     +
         VALUES (                                                                                                                                                                                                                                              +
             'placement_success', p_member_wallet, v_matrix_root, v_entry_node,                                                                                                                                                                                +
             v_parent_wallet, v_slot, v_layer, v_referral_type,                                                                                                                                                                                                +
             p_activation_time, p_tx_hash,                                                                                                                                                                                                                     +
             jsonb_build_object('bfs_order', v_bfs_order, 'fallback_used', false)                                                                                                                                                                              +
         );                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                               +
         RETURN jsonb_build_object(                                                                                                                                                                                                                            +
             'success', true,                                                                                                                                                                                                                                  +
             'message', 'Member placed successfully',                                                                                                                                                                                                          +
             'matrix_root', v_matrix_root,                                                                                                                                                                                                                     +
             'parent_wallet', v_parent_wallet,                                                                                                                                                                                                                 +
             'slot', v_slot,                                                                                                                                                                                                                                   +
             'layer', v_layer,                                                                                                                                                                                                                                 +
             'referral_type', v_referral_type,                                                                                                                                                                                                                 +
             'entry_anchor', v_entry_node,                                                                                                                                                                                                                     +
             'bfs_order', v_bfs_order                                                                                                                                                                                                                          +
         );                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                               +
     EXCEPTION                                                                                                                                                                                                                                                 +
         WHEN unique_violation THEN                                                                                                                                                                                                                            +
             -- Concurrent insertion conflict                                                                                                                                                                                                                  +
             INSERT INTO matrix_placement_events (                                                                                                                                                                                                             +
                 event_type, member_wallet, matrix_root_wallet,                                                                                                                                                                                                +
                 activation_time, tx_hash, error_message                                                                                                                                                                                                       +
             )                                                                                                                                                                                                                                                 +
             VALUES (                                                                                                                                                                                                                                          +
                 'placement_failed', p_member_wallet, v_matrix_root,                                                                                                                                                                                           +
                 p_activation_time, p_tx_hash,                                                                                                                                                                                                                 +
                 'Concurrent placement conflict: ' || SQLERRM                                                                                                                                                                                                  +
             );                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                               +
             RETURN jsonb_build_object(                                                                                                                                                                                                                        +
                 'success', false,                                                                                                                                                                                                                             +
                 'message', 'Concurrent placement conflict (retry)',                                                                                                                                                                                           +
                 'error', SQLERRM                                                                                                                                                                                                                              +
             );                                                                                                                                                                                                                                                +
     END;                                                                                                                                                                                                                                                      +
 END;                                                                                                                                                                                                                                                          +
 $function$                                                                                                                                                                                                                                                    +
 
(1 row)

