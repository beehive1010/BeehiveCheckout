<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesis Matrix Rebuild Verification</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #4CAF50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 8px rgba(76, 175, 80, 0.5);
        }

        .header .status {
            display: inline-block;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            padding: 10px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .stat-card h3 {
            color: #4CAF50;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .stat-card .value {
            font-size: 2.5em;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-card .label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        .tree-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(76, 175, 80, 0.3);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .tree-section h2 {
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .matrix-tree {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 2;
            white-space: pre;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 10px;
        }

        .position-l { color: #4CAF50; font-weight: bold; }
        .position-m { color: #2196F3; font-weight: bold; }
        .position-r { color: #9C27B0; font-weight: bold; }
        .type-direct { color: #4CAF50; }
        .type-spillover { color: #2196F3; }

        .distribution-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .distribution-table th,
        .distribution-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .distribution-table th {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            font-weight: bold;
        }

        .distribution-table tr:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge.success {
            background: #4CAF50;
            color: white;
        }

        .badge.info {
            background: #2196F3;
            color: white;
        }

        .info-box {
            background: rgba(33, 150, 243, 0.2);
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h3 {
            color: #2196F3;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœ… Genesis Matrix Rebuild - éªŒè¯æˆåŠŸ</h1>
            <div class="status">ğŸ‰ Single Matrix System Active</div>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ é‡å»ºæ‘˜è¦</h3>
            <ul>
                <li><strong>è½¬æ¢ç±»å‹</strong>: Generation-Based â†’ Single Matrix</li>
                <li><strong>æ‰§è¡Œæ—¶é—´</strong>: 2025-10-29</li>
                <li><strong>å½±å“èŒƒå›´</strong>: Genesis çŸ©é˜µ (0x479AB...)</li>
                <li><strong>è®°å½•æ•°</strong>: 57 â†’ 4,076 æ¡è®°å½•</li>
                <li><strong>å±‚çº§æ·±åº¦</strong>: 8 å±‚ (Layer 1-7 å®Œæ•´, Layer 8 éƒ¨åˆ†)</li>
            </ul>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>ğŸ“Š æ€»è®°å½•æ•°</h3>
                <div class="value" id="total-records">-</div>
                <div class="label">Genesis Matrix Records</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ”¢ å±‚çº§æ·±åº¦</h3>
                <div class="value" id="total-layers">-</div>
                <div class="label">Layers (Max 19)</div>
            </div>
            <div class="stat-card">
                <h3>âš–ï¸ L/M/R åˆ†å¸ƒ</h3>
                <div class="value" id="distribution">-</div>
                <div class="label">Perfect Balance</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ æ¯ä¸ªçˆ¶èŠ‚ç‚¹</h3>
                <div class="value">3</div>
                <div class="label">å­èŠ‚ç‚¹ (L, M, R)</div>
            </div>
        </div>

        <div class="tree-section">
            <h2>ğŸŒ³ Genesis çŸ©é˜µç»“æ„ (å‰ 12 ä¸ªæˆå‘˜)</h2>
            <div id="matrix-tree" class="matrix-tree loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="tree-section">
            <h2>ğŸ“ˆ å±‚çº§åˆ†å¸ƒè¯¦æƒ…</h2>
            <table class="distribution-table">
                <thead>
                    <tr>
                        <th>Layer</th>
                        <th>Total</th>
                        <th>L</th>
                        <th>M</th>
                        <th>R</th>
                        <th>L%</th>
                        <th>M%</th>
                        <th>R%</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="distribution-table">
                    <tr>
                        <td colspan="9" class="loading">åŠ è½½ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://cvqibjcbfrwsgkvthccp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cWliamNiZnJ3c2drdnRoY2NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2NzI0NTMsImV4cCI6MjA1OTI0ODQ1M30.EgwcfhU9t5j9NtKV3VxPaxLzpL7PFJGNkIJz-yN0hHQ';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const GENESIS_WALLET = '0x479ABda60F8c62a7C3fba411ab948a8BE0E616Ab';

        async function loadStats() {
            try {
                // Get total records
                const { data: allRecords, error: allError } = await supabase
                    .from('matrix_referrals')
                    .select('*', { count: 'exact', head: true })
                    .ilike('matrix_root_wallet', GENESIS_WALLET);

                if (allError) throw allError;

                // Get layer distribution
                const { data: distribution, error: distError } = await supabase
                    .rpc('get_genesis_layer_distribution');

                // Fallback query if RPC doesn't exist
                const { data: layers, error: layerError } = await supabase
                    .from('matrix_referrals')
                    .select('layer')
                    .ilike('matrix_root_wallet', GENESIS_WALLET)
                    .order('layer', { ascending: false })
                    .limit(1);

                if (layers && layers.length > 0) {
                    document.getElementById('total-layers').textContent = layers[0].layer;
                }

                // Get position distribution for all layers
                const { data: positions, error: posError } = await supabase
                    .from('matrix_referrals')
                    .select('position')
                    .ilike('matrix_root_wallet', GENESIS_WALLET);

                if (positions) {
                    const l = positions.filter(p => p.position === 'L').length;
                    const m = positions.filter(p => p.position === 'M').length;
                    const r = positions.filter(p => p.position === 'R').length;
                    const total = positions.length;

                    document.getElementById('total-records').textContent = total.toLocaleString();

                    const lPct = Math.round(100 * l / total);
                    const mPct = Math.round(100 * m / total);
                    const rPct = Math.round(100 * r / total);

                    document.getElementById('distribution').textContent = `${lPct}/${mPct}/${rPct}`;
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadMatrixTree() {
            try {
                const { data, error } = await supabase
                    .from('matrix_referrals')
                    .select('*')
                    .ilike('matrix_root_wallet', GENESIS_WALLET)
                    .lte('layer', 2)
                    .order('bfs_order');

                if (error) throw error;

                displayTree(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('matrix-tree').textContent = 'åŠ è½½å¤±è´¥: ' + error.message;
            }
        }

        function displayTree(data) {
            const layer1 = data.filter(n => n.layer === 1);
            const layer2 = data.filter(n => n.layer === 2);

            let tree = `Genesis (${GENESIS_WALLET.substring(0, 12)}...)\n`;

            layer1.forEach((node, i) => {
                const isLast = i === layer1.length - 1;
                const prefix = isLast ? 'â””â”€â”€' : 'â”œâ”€â”€';
                const posClass = `position-${node.position.toLowerCase()}`;
                const typeClass = node.referral_type === 'direct' ? 'type-direct' : 'type-spillover';
                const typeIcon = node.referral_type === 'direct' ? 'â†—' : 'â†™';

                tree += `${prefix} <span class="${posClass}">${node.position}</span> Member ${node.bfs_order} (${node.member_wallet.substring(0, 10)}...) <span class="${typeClass}">${typeIcon} ${node.referral_type}</span>\n`;

                // Layer 2 children of this node
                const children = layer2.filter(n => n.parent_wallet.toLowerCase() === node.member_wallet.toLowerCase());
                children.forEach((child, j) => {
                    const childPrefix = isLast ? '    ' : 'â”‚   ';
                    const childIsLast = j === children.length - 1;
                    const childBranch = childIsLast ? 'â””â”€â”€' : 'â”œâ”€â”€';
                    const childPosClass = `position-${child.position.toLowerCase()}`;
                    const childTypeClass = child.referral_type === 'direct' ? 'type-direct' : 'type-spillover';
                    const childTypeIcon = child.referral_type === 'direct' ? 'â†—' : 'â†™';

                    tree += `${childPrefix}${childBranch} <span class="${childPosClass}">${child.position}</span> Member ${child.bfs_order} (${child.member_wallet.substring(0, 10)}...) <span class="${childTypeClass}">${childTypeIcon} ${child.referral_type}</span>\n`;
                });
            });

            document.getElementById('matrix-tree').innerHTML = tree;
        }

        async function loadDistribution() {
            try {
                const { data, error } = await supabase
                    .from('matrix_referrals')
                    .select('layer, position')
                    .ilike('matrix_root_wallet', GENESIS_WALLET);

                if (error) throw error;

                // Group by layer
                const layers = {};
                data.forEach(row => {
                    if (!layers[row.layer]) {
                        layers[row.layer] = { L: 0, M: 0, R: 0 };
                    }
                    layers[row.layer][row.position]++;
                });

                // Build table
                let html = '';
                Object.keys(layers).sort((a, b) => a - b).forEach(layer => {
                    const counts = layers[layer];
                    const total = counts.L + counts.M + counts.R;
                    const lPct = Math.round(100 * counts.L / total);
                    const mPct = Math.round(100 * counts.M / total);
                    const rPct = Math.round(100 * counts.R / total);

                    const isBalanced = lPct >= 30 && lPct <= 35 &&
                                     mPct >= 30 && mPct <= 35 &&
                                     rPct >= 30 && rPct <= 35;

                    html += `
                        <tr>
                            <td>${layer}</td>
                            <td>${total}</td>
                            <td>${counts.L}</td>
                            <td>${counts.M}</td>
                            <td>${counts.R}</td>
                            <td>${lPct}%</td>
                            <td>${mPct}%</td>
                            <td>${rPct}%</td>
                            <td>
                                <span class="badge ${isBalanced ? 'success' : 'info'}">
                                    ${isBalanced ? 'âœ… Balanced' : 'âš ï¸ Partial'}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('distribution-table').innerHTML = html;

            } catch (error) {
                console.error('Error loading distribution:', error);
            }
        }

        // Auto-load on page load
        window.addEventListener('load', () => {
            loadStats();
            loadMatrixTree();
            loadDistribution();
        });
    </script>
</body>
</html>
