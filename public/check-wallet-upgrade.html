<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£€æŸ¥é’±åŒ…å‡çº§çŠ¶æ€</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 30px; }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
        }
        .error { color: #e74c3c; }
        .success { color: #27ae60; }
        .warning { color: #f39c12; }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ£€æŸ¥é’±åŒ…å‡çº§çŠ¶æ€</h1>

        <div class="section">
            <h3>é’±åŒ…åœ°å€</h3>
            <input type="text" id="walletInput" placeholder="è¾“å…¥é’±åŒ…åœ°å€ (ä¾‹å¦‚: 0x8C2CDA621f09543Dfe283eDecE34fd2C446Fd735)" value="0x8C2CDA621f09543Dfe283eDecE34fd2C446Fd735">
            <button onclick="checkWalletStatus()">æ£€æŸ¥çŠ¶æ€</button>
            <button onclick="fixLevel2Upgrade()" style="background: #e67e22;">ä¿®å¤Level 2å‡çº§</button>
        </div>

        <div class="section">
            <h3>æ£€æŸ¥ç»“æœ</h3>
            <div id="result">ç‚¹å‡»"æ£€æŸ¥çŠ¶æ€"æŒ‰é’®å¼€å§‹...</div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://vxqjqspwutxlrysvjshd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4cWpxc3B3dXR4bHJ5c3Zqc2hkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgxOTgxMDksImV4cCI6MjA0Mzc3NDEwOX0.b-13dVXigNlo0kICWzqItMYLP7_T5yoq5dHvVDH-IxE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function checkWalletStatus() {
            const wallet = document.getElementById('walletInput').value.trim();
            const resultDiv = document.getElementById('result');

            if (!wallet) {
                resultDiv.innerHTML = '<p class="error">è¯·è¾“å…¥é’±åŒ…åœ°å€</p>';
                return;
            }

            resultDiv.innerHTML = '<p>æ­£åœ¨æ£€æŸ¥...</p>';

            try {
                // 1. æ£€æŸ¥ members è¡¨
                const { data: memberData, error: memberError } = await supabase
                    .from('members')
                    .select('wallet_address, current_level, username, activation_time, updated_at')
                    .ilike('wallet_address', wallet)
                    .maybeSingle();

                // 2. æ£€æŸ¥ membership è¡¨
                const { data: membershipData, error: membershipError } = await supabase
                    .from('membership')
                    .select('nft_level, unlock_membership_level, is_member, claimed_at, claim_price, transaction_hash')
                    .ilike('wallet_address', wallet)
                    .order('nft_level', { ascending: true });

                // 3. æ£€æŸ¥ç›´æ¨æ•°é‡
                const { count: referralCount, error: referralError } = await supabase
                    .from('referrals')
                    .select('*', { count: 'exact', head: true })
                    .ilike('referrer_wallet', wallet)
                    .eq('referral_depth', 1);

                // 4. æ£€æŸ¥ layer_rewards
                const { data: layerRewardsData, error: layerRewardsError } = await supabase
                    .from('layer_rewards')
                    .select('triggering_nft_level, status, reward_amount')
                    .ilike('triggering_member_wallet', wallet)
                    .order('triggering_nft_level', { ascending: true });

                // æ„å»ºç»“æœæ˜¾ç¤º
                let html = '';

                // Members è¡¨
                html += '<h4>1. Members è¡¨</h4>';
                if (memberError) {
                    html += `<p class="error">é”™è¯¯: ${memberError.message}</p>`;
                } else if (!memberData) {
                    html += '<p class="warning">æœªæ‰¾åˆ°è¯¥é’±åŒ…çš„ä¼šå‘˜è®°å½•</p>';
                } else {
                    html += '<pre>' + JSON.stringify(memberData, null, 2) + '</pre>';
                }

                // Membership è¡¨
                html += '<h4>2. Membership è¡¨ (æ‰€æœ‰ç­‰çº§)</h4>';
                if (membershipError) {
                    html += `<p class="error">é”™è¯¯: ${membershipError.message}</p>`;
                } else if (!membershipData || membershipData.length === 0) {
                    html += '<p class="warning">æœªæ‰¾åˆ°ä»»ä½•ä¼šå‘˜ç­‰çº§è®°å½•</p>';
                } else {
                    html += '<pre>' + JSON.stringify(membershipData, null, 2) + '</pre>';

                    // åˆ†æé—®é¢˜
                    const hasLevel1 = membershipData.some(m => m.nft_level === 1);
                    const hasLevel2 = membershipData.some(m => m.nft_level === 2);
                    const level2Data = membershipData.find(m => m.nft_level === 2);

                    html += '<h4 style="color: #e67e22;">è¯Šæ–­åˆ†æ</h4>';
                    html += '<ul>';
                    html += `<li>æ‹¥æœ‰ Level 1: ${hasLevel1 ? '<span class="success">âœ“ æ˜¯</span>' : '<span class="error">âœ— å¦</span>'}</li>`;
                    html += `<li>æ‹¥æœ‰ Level 2: ${hasLevel2 ? '<span class="success">âœ“ æ˜¯</span>' : '<span class="error">âœ— å¦</span>'}</li>`;

                    if (hasLevel2 && level2Data) {
                        html += `<li>Level 2 unlock_membership_level: ${level2Data.unlock_membership_level || '<span class="error">NULL</span>'}</li>`;
                        if (!level2Data.unlock_membership_level || level2Data.unlock_membership_level !== 3) {
                            html += '<li class="error">âš ï¸ é—®é¢˜: unlock_membership_level åº”è¯¥æ˜¯ 3</li>';
                        } else {
                            html += '<li class="success">âœ“ unlock_membership_level æ­£ç¡®</li>';
                        }
                    }

                    if (memberData && hasLevel2 && memberData.current_level !== 2) {
                        html += `<li class="error">âš ï¸ é—®é¢˜: members.current_level (${memberData.current_level}) ä¸æœ€é«˜æ‹¥æœ‰ç­‰çº§ (2) ä¸ä¸€è‡´</li>`;
                    }
                    html += '</ul>';
                }

                // ç›´æ¨æ•°é‡
                html += '<h4>3. ç›´æ¨æ•°é‡</h4>';
                if (referralError) {
                    html += `<p class="error">é”™è¯¯: ${referralError.message}</p>`;
                } else {
                    html += `<p>ç›´æ¨äººæ•°: <strong>${referralCount || 0}</strong></p>`;
                    if ((referralCount || 0) >= 3) {
                        html += '<p class="success">âœ“ æ»¡è¶³ Level 2 å‡çº§æ¡ä»¶ (â‰¥3äºº)</p>';
                    } else {
                        html += `<p class="error">âœ— ä¸æ»¡è¶³ Level 2 å‡çº§æ¡ä»¶ (éœ€è¦${3 - (referralCount || 0)}äºº)</p>`;
                    }
                }

                // Layer Rewards
                html += '<h4>4. Layer Rewards æ±‡æ€»</h4>';
                if (layerRewardsError) {
                    html += `<p class="error">é”™è¯¯: ${layerRewardsError.message}</p>`;
                } else if (!layerRewardsData || layerRewardsData.length === 0) {
                    html += '<p class="warning">æœªæ‰¾åˆ°ä»»ä½•å¥–åŠ±è®°å½•</p>';
                } else {
                    const summary = {};
                    layerRewardsData.forEach(reward => {
                        const level = reward.triggering_nft_level;
                        if (!summary[level]) {
                            summary[level] = { count: 0, total: 0, byStatus: {} };
                        }
                        summary[level].count++;
                        summary[level].total += reward.reward_amount;
                        summary[level].byStatus[reward.status] = (summary[level].byStatus[reward.status] || 0) + 1;
                    });

                    html += '<pre>' + JSON.stringify(summary, null, 2) + '</pre>';
                }

                resultDiv.innerHTML = html;

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
                console.error('æ£€æŸ¥é”™è¯¯:', error);
            }
        }

        async function fixLevel2Upgrade() {
            const wallet = document.getElementById('walletInput').value.trim();
            const resultDiv = document.getElementById('result');

            if (!wallet) {
                alert('è¯·è¾“å…¥é’±åŒ…åœ°å€');
                return;
            }

            if (!confirm(`ç¡®å®šè¦ä¿®å¤é’±åŒ… ${wallet} çš„ Level 2 å‡çº§çŠ¶æ€å—ï¼Ÿ`)) {
                return;
            }

            resultDiv.innerHTML = '<p>æ­£åœ¨ä¿®å¤...</p>';

            try {
                // 1. æ›´æ–° membership è¡¨çš„ unlock_membership_level
                const { error: updateError } = await supabase
                    .from('membership')
                    .update({ unlock_membership_level: 3 })
                    .ilike('wallet_address', wallet)
                    .eq('nft_level', 2);

                if (updateError) {
                    throw new Error(`æ›´æ–° membership å¤±è´¥: ${updateError.message}`);
                }

                // 2. æ›´æ–° members è¡¨çš„ current_level
                const { error: memberUpdateError } = await supabase
                    .from('members')
                    .update({
                        current_level: 2,
                        updated_at: new Date().toISOString()
                    })
                    .ilike('wallet_address', wallet);

                if (memberUpdateError) {
                    throw new Error(`æ›´æ–° members å¤±è´¥: ${memberUpdateError.message}`);
                }

                resultDiv.innerHTML = '<p class="success">âœ“ ä¿®å¤æˆåŠŸï¼å·²æ›´æ–°:</p>' +
                    '<ul>' +
                    '<li>membership.unlock_membership_level = 3 (Level 2 è®°å½•)</li>' +
                    '<li>members.current_level = 2</li>' +
                    '</ul>' +
                    '<p>è¯·é‡æ–°æ£€æŸ¥çŠ¶æ€...</p>';

                // è‡ªåŠ¨é‡æ–°æ£€æŸ¥
                setTimeout(checkWalletStatus, 1000);

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">ä¿®å¤å¤±è´¥: ${error.message}</p>`;
                console.error('ä¿®å¤é”™è¯¯:', error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            checkWalletStatus();
        });
    </script>
</body>
</html>
