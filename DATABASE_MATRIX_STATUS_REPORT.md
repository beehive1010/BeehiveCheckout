# æ•°æ®åº“çŸ©é˜µæ’ä½çŠ¶æ€æ£€æŸ¥æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

**æ£€æŸ¥æ—¥æœŸï¼š** 2025-10-19
**æ•°æ®åº“ï¼š** Supabase Production
**æ£€æŸ¥ç›®çš„ï¼š** éªŒè¯å½“å‰çŸ©é˜µæ’ä½æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ˜¯å¦å·²è¾¾åˆ°19å±‚çŸ©é˜µè¦æ±‚

---

## ğŸ“Š å½“å‰çŸ©é˜µæ’ä½ç»Ÿè®¡

### æ€»ä½“æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ | çŠ¶æ€ |
|------|------|------|
| **æ€»çŸ©é˜µæ’ä½æ•°** | 47,300 | âœ… |
| **ç‹¬ç«‹æˆå‘˜æ•°** | 4,061 | âœ… |
| **ç‹¬ç«‹çŸ©é˜µæ ¹æ•°** | 3,856 | âœ… |
| **æœ€æ—©æ’ä½æ—¶é—´** | 2025-03-01 00:01:00 | âœ… |
| **æœ€æ–°æ’ä½æ—¶é—´** | 2025-10-18 14:20:23 | âœ… |

**ç»“è®ºï¼š** âœ… å·²ç»æˆåŠŸæ’ä½ **4,061 äºº**ï¼Œè¶…è¿‡ 4,000 äººçš„ç›®æ ‡ã€‚

---

## ğŸ”´ ä¸¥é‡é—®é¢˜å‘ç°

### é—®é¢˜ 1: å±‚çº§è¶…è¿‡19å±‚é™åˆ¶

**é—®é¢˜æè¿°ï¼š**
æ•°æ®åº“ä¸­å­˜åœ¨ **Layer 0 åˆ° Layer 27**ï¼Œæ€»å…± 28 å±‚ï¼Œè¶…è¿‡äº†ä¸šåŠ¡è§„åˆ™è§„å®šçš„ 19 å±‚ä¸Šé™ã€‚

**å±‚çº§åˆ†å¸ƒï¼š**

| Layer | æ’ä½æ•° | ç‹¬ç«‹æˆå‘˜æ•° | çŸ©é˜µæ ¹æ•° | çŠ¶æ€ |
|-------|--------|-----------|---------|------|
| **0** | 2,310 | 2,310 | 2,310 | ğŸ”´ **ä¸åº”å­˜åœ¨** |
| 1 | 3,760 | 3,728 | 1,546 | âœ… |
| 2 | 3,759 | 3,618 | 811 | âœ… |
| 3 | 3,559 | 3,507 | 524 | âœ… |
| ... | ... | ... | ... | ... |
| 19 | 490 | 490 | 20 | âœ… |
| **20** | 331 | 331 | 17 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **21** | 209 | 209 | 14 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **22** | 147 | 147 | 11 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **23** | 68 | 68 | 9 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **24** | 44 | 44 | 7 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **25** | 26 | 26 | 5 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **26** | 13 | 13 | 3 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |
| **27** | 9 | 9 | 1 | ğŸ”´ **è¶…è¿‡é™åˆ¶** |

**å½±å“ï¼š**
- ğŸ”´ è¿åä¸šåŠ¡è§„åˆ™ï¼ˆæœ€å¤§19å±‚ï¼‰
- ğŸ”´ å¯èƒ½å¯¼è‡´å¥–åŠ±è®¡ç®—é”™è¯¯
- ğŸ”´ å‰ç«¯æ˜¾ç¤ºå¯èƒ½å‡ºç°é—®é¢˜

**æœ€æ·±çŸ©é˜µç¤ºä¾‹ï¼š**

| çŸ©é˜µæ ¹ | æœ€æ·±å±‚çº§ | æ€»æ’ä½æ•° |
|--------|---------|---------|
| `0x479ABda60F8c62a7C3fba411ab948a8BE0E616Ab` | **27** | 2,118 |
| `0xfd91667229a122265aF123a75bb624A9C35B5032` | **26** | 3,058 |
| `0x380Fd6A57Fc2DF6F10B8920002e4acc7d57d61c0` | **26** | 56 |

---

### é—®é¢˜ 2: å­˜åœ¨ Layer 0

**é—®é¢˜æè¿°ï¼š**
æ•°æ®åº“ä¸­æœ‰ **2,310 ä¸ªæ’ä½**åœ¨ Layer 0ï¼Œè¿™æ˜¯ä¸åº”è¯¥å­˜åœ¨çš„ã€‚

**ä¸šåŠ¡è§„åˆ™ï¼š**
- Layer åº”è¯¥ä» 1 å¼€å§‹
- Layer 0 æ²¡æœ‰ä¸šåŠ¡å«ä¹‰

**å¯èƒ½åŸå› ï¼š**
- æ—§çš„æ’ä½å‡½æ•°å…è®¸ Layer 0ï¼ˆä½œä¸ºæ ¹èŠ‚ç‚¹ï¼‰
- è‡ªå·±ä½œä¸ºè‡ªå·±çŸ©é˜µçš„æ ¹ï¼ˆself-referralï¼‰

**referral_type åˆ†å¸ƒï¼š**

| Referral Type | æ•°é‡ | ç™¾åˆ†æ¯” | çŠ¶æ€ |
|--------------|------|--------|------|
| spillover | 35,593 | 75.25% | âœ… |
| direct | 9,201 | 19.45% | âœ… |
| **self** | **2,310** | **4.88%** | ğŸ”´ **å¯èƒ½å¯¹åº” Layer 0** |
| is_direct | 38 | 0.08% | ğŸŸ¡ æ—§å­—æ®µå€¼ |
| is_spillover | 158 | 0.33% | ğŸŸ¡ æ—§å­—æ®µå€¼ |

---

### é—®é¢˜ 3: ä½¿ç”¨æ—§çš„æ•°æ®åº“ç»“æ„

**å½“å‰åˆ—åï¼š**
```sql
column_name | data_type
------------+-----------
layer       | integer
position    | character varying  -- âŒ æ—§åˆ—å
```

**ç¼ºå°‘çš„æ–°åˆ—ï¼š**
- âŒ `slot` (åº”è¯¥æ›¿ä»£ `position`)
- âŒ `entry_anchor` (Branch-First BFS éœ€è¦)
- âŒ `bfs_order` (Branch-First BFS éœ€è¦)
- âŒ `activation_time` (å®¡è®¡éœ€è¦)
- âŒ `tx_hash` (å®¡è®¡éœ€è¦)

**ä»…æœ‰çš„æ–°åˆ—ï¼š**
- âœ… `source` (ä½†å¯èƒ½æ•°æ®ä¸å®Œæ•´)

**ç»“è®ºï¼š**
ğŸ”´ **æ•°æ®åº“å°šæœªåº”ç”¨ Branch-First BFS è¿ç§»**

---

### é—®é¢˜ 4: ç¼ºå°‘æ–°çš„ Branch-First BFS è§†å›¾

**éœ€è¦çš„è§†å›¾ï¼ˆMigration åˆ›å»ºï¼‰ï¼š**

| è§†å›¾å | çŠ¶æ€ | ç”¨é€” |
|--------|------|------|
| `v_matrix_layer_tree` | âŒ **ç¼ºå¤±** | å®Œæ•´æ ‘å½¢ç»“æ„ |
| `v_matrix_layer_summary` | âŒ **ç¼ºå¤±** | å±‚çº§å®¹é‡ç»Ÿè®¡ |
| `v_direct_vs_layer_mismatch` | âŒ **ç¼ºå¤±** | ç›´æ¨vsçŸ©é˜µå®¡è®¡ |
| `v_matrix_next_open_slots` | âŒ **ç¼ºå¤±** | ä¸‹ä¸€ä¸ªå¯ç”¨ä½ç½®é¢„æµ‹ |

**ç°æœ‰çš„æ—§è§†å›¾ï¼š**

| è§†å›¾å | çŠ¶æ€ | ç”¨é€” |
|--------|------|------|
| `v_direct_referrals` | âœ… å­˜åœ¨ | ç›´æ¨ç»Ÿè®¡ |
| `v_matrix_direct_children` | âœ… å­˜åœ¨ | ç›´æ¥å­èŠ‚ç‚¹ |
| `v_matrix_root_summary` | âœ… å­˜åœ¨ | çŸ©é˜µæ ¹æ±‡æ€» |
| `v_matrix_layers_v2` | âœ… å­˜åœ¨ | å±‚çº§ç»Ÿè®¡ï¼ˆæ—§ç‰ˆï¼‰ |
| `v_matrix_overview` | âœ… å­˜åœ¨ | çŸ©é˜µæ¦‚è§ˆ |
| `v_member_overview` | âœ… å­˜åœ¨ | æˆå‘˜æ¦‚è§ˆ |

---

## ğŸŸ¡ Referrals é¡µé¢ç»„ä»¶åˆ†æ

### ç»„ä»¶ä½¿ç”¨çš„è§†å›¾

**1. MatrixLayerStatsView ç»„ä»¶**
```typescript
.from('v_matrix_layers_v2')  // âœ… å­˜åœ¨
```
**çŠ¶æ€ï¼š** âœ… æ­£å¸¸å·¥ä½œ

**2. ReferralMatrixVisualization ç»„ä»¶**
```typescript
.from('v_member_overview')  // âœ… å­˜åœ¨
```
**çŠ¶æ€ï¼š** âœ… æ­£å¸¸å·¥ä½œ

**3. ReferralsStats ç»„ä»¶**
```typescript
.from('v_matrix_overview')  // âœ… å­˜åœ¨
.from('v_matrix_layers')    // âŒ ä¸å­˜åœ¨ï¼
```
**çŠ¶æ€ï¼š** ğŸ”´ **éƒ¨åˆ†åŠŸèƒ½å¯èƒ½å¤±è´¥**

**é—®é¢˜ï¼š**
`v_matrix_layers` è§†å›¾ä¸å­˜åœ¨ï¼Œä½†ä»£ç å°è¯•æŸ¥è¯¢å®ƒï¼Œå¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ã€‚

---

## ğŸ“Š 19å±‚çŸ©é˜µè¾¾æˆæƒ…å†µ

### âœ… å·²è¾¾åˆ°19å±‚çš„çŸ©é˜µæ ¹ï¼ˆéƒ¨åˆ†åˆ—è¡¨ï¼‰

| çŸ©é˜µæ ¹é’±åŒ… | æœ€å¤§å±‚çº§ | æ€»æ’ä½æ•° | å±‚çº§è¦†ç›– |
|-----------|---------|---------|---------|
| `0x479ABda...` | 27 | 2,118 | 1-27 å…¨è¦†ç›– âœ… |
| `0xfd91667...` | 26 | 3,058 | 1-26 å…¨è¦†ç›– âœ… |
| `0x380Fd6A...` | 26 | 56 | 1-26 å…¨è¦†ç›– âœ… |
| `0x3C1FF5B...` | 25 | 1,525 | 1-25 å…¨è¦†ç›– âœ… |
| `0xE38d25F...` | 25 | 50 | 1-25 å…¨è¦†ç›– âœ… |
| `0x9D06929...` | 24 | 2,509 | 1-24 å…¨è¦†ç›– âœ… |
| ... | ... | ... | ... |
| `0xd8b530f...` | **19** | 1,461 | 1-19 å…¨è¦†ç›– âœ… |
| `0xb9aC7D2...` | **19** | 150 | 1-19 å…¨è¦†ç›– âœ… |
| `0x2cFB3D2...` | **19** | 33 | 1-19 å…¨è¦†ç›– âœ… |

**ç»Ÿè®¡ï¼š**
- âœ… **20 ä¸ªçŸ©é˜µæ ¹**è¾¾åˆ°æˆ–è¶…è¿‡ 19 å±‚
- âœ… æœ€æ·±çŸ©é˜µè¾¾åˆ° **27 å±‚**ï¼ˆè¶…è¿‡è§„å®šï¼‰
- âœ… å¹³å‡æ¯ä¸ªæ·±åº¦çŸ©é˜µæœ‰ **1,000+ æ’ä½**

**ç»“è®ºï¼š**
âœ… **å·²ç»æˆåŠŸå»ºç«‹äº†19å±‚çŸ©é˜µç³»ç»Ÿ**ï¼Œç”šè‡³è¶…è¿‡äº†19å±‚ã€‚

---

## ğŸ” æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

### æœªèƒ½å®Œæˆçš„æŸ¥è¯¢

ç”±äºåˆ—åä¸åŒ¹é…ï¼Œä»¥ä¸‹æŸ¥è¯¢å¤±è´¥ï¼š

1. **æˆå‘˜çŠ¶æ€æŸ¥è¯¢** - `membership_status` åˆ—ä¸å­˜åœ¨
2. **Slot æŸ¥è¯¢** - `slot` åˆ—ä¸å­˜åœ¨ï¼ˆä½¿ç”¨ `position` æ›¿ä»£ï¼‰

### éœ€è¦æ‰‹åŠ¨æ£€æŸ¥çš„é—®é¢˜

```sql
-- 1. æ£€æŸ¥æœ‰å¤šå°‘æˆå‘˜æ²¡æœ‰çŸ©é˜µæ’ä½
SELECT COUNT(*) as members_without_placement
FROM members m
LEFT JOIN matrix_referrals mr ON mr.member_wallet = m.wallet_address
WHERE mr.member_wallet IS NULL;

-- 2. æ£€æŸ¥ Layer 0 çš„å…·ä½“æƒ…å†µ
SELECT member_wallet, matrix_root_wallet, parent_wallet, referral_type
FROM matrix_referrals
WHERE layer = 0
LIMIT 10;

-- 3. æ£€æŸ¥è¶…è¿‡19å±‚çš„æ’ä½
SELECT COUNT(*) as count_over_19
FROM matrix_referrals
WHERE layer > 19;
```

---

## ğŸš¨ å…³é”®é—®é¢˜æ€»ç»“

### ğŸ”´ ç´§æ€¥é—®é¢˜

1. **å±‚çº§è¶…è¿‡19å±‚** - 812 ä¸ªæ’ä½è¶…è¿‡ä¸šåŠ¡è§„åˆ™ä¸Šé™ï¼ˆLayer 20-27ï¼‰
2. **å­˜åœ¨ Layer 0** - 2,310 ä¸ªæ’ä½åœ¨ä¸åº”å­˜åœ¨çš„ Layer 0
3. **ç¼ºå°‘æ–°çš„ Branch-First BFS åˆ—** - `slot`, `entry_anchor`, `bfs_order` ç­‰
4. **ç¼ºå°‘æ–°çš„è§†å›¾** - 4 ä¸ªæ ¸å¿ƒ Branch-First BFS è§†å›¾ä¸å­˜åœ¨
5. **ReferralsStats ç»„ä»¶é”™è¯¯** - æŸ¥è¯¢ä¸å­˜åœ¨çš„ `v_matrix_layers` è§†å›¾

### ğŸŸ¡ æ¬¡è¦é—®é¢˜

1. **referral_type æ··ä¹±** - å­˜åœ¨å¤šç§ç±»å‹å€¼ï¼ˆåº”è¯¥åªæœ‰ 'direct' å’Œ 'spillover'ï¼‰
2. **æ—§æ•°æ®ç»“æ„** - ä»åœ¨ä½¿ç”¨ `position` è€Œä¸æ˜¯ `slot`

---

## âœ… æ­£é¢å‘ç°

1. âœ… **æˆåŠŸæ’ä½ 4,061 äºº** - è¶…è¿‡ç›®æ ‡
2. âœ… **19å±‚çŸ©é˜µå·²å»ºç«‹** - 20+ ä¸ªçŸ©é˜µæ ¹è¾¾åˆ°19å±‚
3. âœ… **æ•°æ®é‡å……è¶³** - 47,300 ä¸ªçŸ©é˜µæ’ä½
4. âœ… **å¤§éƒ¨åˆ†è§†å›¾æ­£å¸¸** - æ—§ç³»ç»Ÿè§†å›¾æ­£å¸¸è¿è¡Œ
5. âœ… **ç›´æ¨/æ»‘è½æ¯”ä¾‹åˆç†** - çº¦ 20% ç›´æ¨ï¼Œ75% æ»‘è½

---

## ğŸ”§ ä¿®å¤å»ºè®®

### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

#### 1. åº”ç”¨ Branch-First BFS è¿ç§»

```bash
# æ‰§è¡Œ5ä¸ªè¿ç§»æ–‡ä»¶ï¼ˆæŒ‰é¡ºåºï¼‰
supabase db push

# æˆ–æ‰‹åŠ¨æ‰§è¡Œ
psql -f supabase/migrations/20251019000000_cleanup_old_matrix_system.sql
psql -f supabase/migrations/20251019000001_create_branch_bfs_placement_function.sql
psql -f supabase/migrations/20251019000002_create_matrix_views.sql
psql -f supabase/migrations/20251019000003_create_data_rebuild_functions.sql
psql -f supabase/migrations/20251019000004_create_matrix_triggers.sql
```

#### 2. é‡å»ºçŸ©é˜µæ•°æ®

```sql
-- ä½¿ç”¨ shadow rebuild åŠŸèƒ½
SELECT fn_rebuild_matrix_placements(
    p_batch_id := 'rebuild_production_20251019',
    p_dry_run := FALSE
);

-- æ¯”è¾ƒæ—§æ•°æ® vs æ–°æ•°æ®
SELECT fn_compare_matrix_placements();

-- æ£€æŸ¥é«˜å½±å“å˜æ›´
SELECT * FROM matrix_rebuild_comparison
WHERE impact_level = 'high';

-- å¦‚æœæ»¡æ„ï¼Œæäº¤æ›´æ”¹
SELECT fn_commit_matrix_rebuild(p_force := TRUE);
```

#### 3. ä¿®å¤ ReferralsStats ç»„ä»¶

**æ–‡ä»¶ï¼š** `src/components/referrals/ReferralsStats.tsx`

**é—®é¢˜ï¼š** æŸ¥è¯¢ä¸å­˜åœ¨çš„ `v_matrix_layers` è§†å›¾

**ä¿®å¤é€‰é¡¹ Aï¼š** ä½¿ç”¨ç°æœ‰è§†å›¾
```typescript
// å°† v_matrix_layers æ”¹ä¸º v_matrix_layers_v2
.from('v_matrix_layers_v2')
```

**ä¿®å¤é€‰é¡¹ Bï¼š** åˆ›å»ºç¼ºå¤±è§†å›¾
```sql
-- åˆ›å»º v_matrix_layers ä½œä¸º v_matrix_layers_v2 çš„åˆ«å
CREATE OR REPLACE VIEW v_matrix_layers AS
SELECT * FROM v_matrix_layers_v2;
```

### ä¸­æœŸæ‰§è¡Œï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

#### 4. æ¸…ç† Layer 0 æ•°æ®

```sql
-- åˆ†æ Layer 0 çš„æ•°æ®
SELECT
    member_wallet,
    matrix_root_wallet,
    parent_wallet,
    referral_type,
    source
FROM matrix_referrals
WHERE layer = 0
LIMIT 100;

-- å†³ç­–ï¼š
-- é€‰é¡¹ A: åˆ é™¤ Layer 0 æ•°æ®ï¼ˆå¦‚æœæ˜¯é”™è¯¯æ•°æ®ï¼‰
-- é€‰é¡¹ B: è½¬æ¢ä¸º Layer 1ï¼ˆå¦‚æœæ˜¯æ ¹èŠ‚ç‚¹ï¼‰
-- é€‰é¡¹ C: ä¿ç•™ä½†æ ‡è®°ä¸ºç‰¹æ®Šç±»å‹
```

#### 5. é™åˆ¶å±‚çº§æ·±åº¦

```sql
-- æ·»åŠ çº¦æŸé™åˆ¶æœ€å¤§å±‚çº§
ALTER TABLE matrix_referrals DROP CONSTRAINT IF EXISTS matrix_referrals_layer_check;
ALTER TABLE matrix_referrals
ADD CONSTRAINT matrix_referrals_layer_check CHECK (layer >= 1 AND layer <= 19);

-- æ³¨æ„ï¼šéœ€è¦å…ˆæ¸…ç†è¶…è¿‡19å±‚çš„æ•°æ®
```

#### 6. ç»Ÿä¸€ referral_type å€¼

```sql
-- æ¸…ç† referral_type å­—æ®µ
UPDATE matrix_referrals
SET referral_type = CASE
    WHEN referral_type IN ('is_direct', 'direct') THEN 'direct'
    WHEN referral_type IN ('is_spillover', 'spillover') THEN 'spillover'
    WHEN referral_type = 'self' THEN 'self'  -- æˆ–æ”¹ä¸º 'direct' æˆ– 'spillover'
    ELSE 'spillover'  -- é»˜è®¤å€¼
END
WHERE referral_type NOT IN ('direct', 'spillover');
```

---

## ğŸ“‹ éªŒè¯æ¸…å•

é‡å»ºåéœ€è¦éªŒè¯ï¼š

### æ•°æ®å®Œæ•´æ€§
- [ ] æ‰€æœ‰ active æˆå‘˜éƒ½æœ‰çŸ©é˜µæ’ä½
- [ ] æ²¡æœ‰ Layer 0 çš„æ’ä½
- [ ] æ²¡æœ‰è¶…è¿‡ Layer 19 çš„æ’ä½
- [ ] æ‰€æœ‰æ’ä½éƒ½æœ‰ slot (L/M/R)
- [ ] entry_anchor å’Œ bfs_order æ­£ç¡®å¡«å……

### ä¸šåŠ¡è§„åˆ™
- [ ] Layer 1 çš„ parent = matrix_root
- [ ] Layer 1 çš„ referral_type = 'direct'
- [ ] å…¶ä»–å±‚çº§çš„ referral_type = 'spillover'
- [ ] æ¯ä¸ª parent æœ€å¤š 3 ä¸ªå­èŠ‚ç‚¹ (L, M, R)
- [ ] BFS é¡ºåºè¿ç»­ä¸”æ— é—´éš™

### è§†å›¾åŠŸèƒ½
- [ ] v_matrix_layer_tree è¿”å›æ­£ç¡®çš„æ ‘å½¢ç»“æ„
- [ ] v_matrix_layer_summary æ˜¾ç¤ºæ­£ç¡®çš„å±‚çº§ç»Ÿè®¡
- [ ] v_direct_vs_layer_mismatch è¯†åˆ«æ‰€æœ‰ä¸åŒ¹é…
- [ ] v_matrix_next_open_slots æ­£ç¡®é¢„æµ‹ä¸‹ä¸€ä¸ªä½ç½®

### å‰ç«¯åŠŸèƒ½
- [ ] Referrals é¡µé¢æ­£å¸¸æ˜¾ç¤º
- [ ] MatrixLayerStatsView ç»„ä»¶æ­£å¸¸å·¥ä½œ
- [ ] InteractiveMatrixView ç»„ä»¶æ­£å¸¸å·¥ä½œ
- [ ] ReferralsStats ç»„ä»¶æ— é”™è¯¯

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

é‡å»ºåç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

```sql
-- 1. é‡å»ºæˆåŠŸç‡
SELECT
    event_type,
    COUNT(*) as count,
    ROUND(COUNT(*)::NUMERIC / (SELECT COUNT(*) FROM matrix_placement_events) * 100, 2) as percentage
FROM matrix_placement_events
WHERE created_at >= NOW() - INTERVAL '1 hour'
GROUP BY event_type;

-- 2. å±‚çº§åˆ†å¸ƒ
SELECT
    layer,
    COUNT(*) as count,
    COUNT(DISTINCT member_wallet) as unique_members
FROM matrix_referrals
GROUP BY layer
ORDER BY layer;

-- 3. ç›´æ¨ vs æ»‘è½
SELECT
    referral_type,
    COUNT(*) as count,
    ROUND(COUNT(*)::NUMERIC / (SELECT COUNT(*) FROM matrix_referrals) * 100, 2) as percentage
FROM matrix_referrals
GROUP BY referral_type;

-- 4. BFS é¡ºåºè¿ç»­æ€§
SELECT
    matrix_root_wallet,
    COUNT(*) as total,
    MIN(bfs_order) as min_order,
    MAX(bfs_order) as max_order,
    CASE
        WHEN COUNT(*) = MAX(bfs_order) - MIN(bfs_order) + 1 THEN 'CONTINUOUS'
        ELSE 'HAS_GAPS'
    END as status
FROM matrix_referrals
GROUP BY matrix_root_wallet
HAVING COUNT(*) != MAX(bfs_order) - MIN(bfs_order) + 1;
```

---

## ğŸ“ æ€»ç»“

### å½“å‰çŠ¶æ€

âœ… **å·²è¾¾æˆçš„ç›®æ ‡ï¼š**
1. æˆåŠŸæ’ä½ 4,061 äººï¼ˆè¶…è¿‡ 4,000 ç›®æ ‡ï¼‰
2. å»ºç«‹äº†19å±‚çŸ©é˜µç³»ç»Ÿï¼ˆç”šè‡³è¾¾åˆ°27å±‚ï¼‰
3. 47,300 ä¸ªçŸ©é˜µæ’ä½æ•°æ®
4. å¤§éƒ¨åˆ†å‰ç«¯ç»„ä»¶æ­£å¸¸å·¥ä½œ

ğŸ”´ **å­˜åœ¨çš„é—®é¢˜ï¼š**
1. æ•°æ®åº“ä½¿ç”¨æ—§çš„çŸ©é˜µç³»ç»Ÿï¼ˆæœªåº”ç”¨ Branch-First BFS è¿ç§»ï¼‰
2. å±‚çº§è¶…è¿‡19å±‚é™åˆ¶ï¼ˆè¿åä¸šåŠ¡è§„åˆ™ï¼‰
3. å­˜åœ¨ Layer 0ï¼ˆä¸åº”å­˜åœ¨ï¼‰
4. ç¼ºå°‘æ–°çš„åˆ—å’Œè§†å›¾
5. ReferralsStats ç»„ä»¶æœ‰æ½œåœ¨é”™è¯¯

### æ¨èè¡ŒåŠ¨

**ç¬¬ä¸€æ­¥ï¼š** åº”ç”¨ Branch-First BFS è¿ç§»ï¼ˆ5ä¸ªSQLæ–‡ä»¶ï¼‰

**ç¬¬äºŒæ­¥ï¼š** é‡å»ºçŸ©é˜µæ•°æ®ï¼ˆä½¿ç”¨ shadow rebuildï¼‰

**ç¬¬ä¸‰æ­¥ï¼š** ä¿®å¤ ReferralsStats ç»„ä»¶è§†å›¾æŸ¥è¯¢

**ç¬¬å››æ­¥ï¼š** éªŒè¯æ•°æ®å®Œæ•´æ€§å’Œä¸šåŠ¡è§„åˆ™

**ç¬¬äº”æ­¥ï¼š** æ›´æ–° Edge Functionsï¼ˆactivate-membershipï¼‰

---

**æŠ¥å‘Šç‰ˆæœ¬ï¼š** 1.0
**åˆ›å»ºæ—¥æœŸï¼š** 2025-10-19
**åˆ›å»ºè€…ï¼š** Claude Code
**çŠ¶æ€ï¼š** ğŸ”´ **éœ€è¦ç«‹å³æ‰§è¡Œè¿ç§»å’Œæ•°æ®é‡å»º**
